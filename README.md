# jgi-user-meeting-aws-accounts
Using terraform to automatically provision AWS accounts
* JGI Required IAM Permissions: https://blast.ncbi.nlm.nih.gov/doc/elastic-blast/iam-policy.html
  * for Elastic-BLAST execution, AWS Batch and CloudWatch
* JGI Required EC2 instance
  * SRAtoolkit, awscli, python3.10-venv, numpy, ncbi-blast+, and elastic-blast (v0.2.6)

## 1. Install Terraform (1.2.0+ required):
### Mac OS X
```
$ brew install terraform
$ brew update
$ brew upgrade terraform
$ terraform --version
```

## 2. AWS credentials setup
To use your IAM credentials to authenticate the Terraform AWS provider, set the `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` environment variables.
```
$ export AWS_ACCESS_KEY_ID=
$ export AWS_SECRET_ACCESS_KEY=
```

## 3. Generate PGP key pair
### Generate PGP key pair using GPG
This key pair will be used for IAM user credentials encryption & decryption.
To decrypt credentials automatically, skip the password protection step when generating the key pair.
```
$ gpg --full-generate-key
```
### Export PGP public key
`@user_email` is the email address used when PGP key pair was generated by GPG
```
$ gpg  --output public.pgp --armor --export @user_email
```
The PGP public key is in `public.pgp` between `-----BEGIN PGP PUBLIC KEY BLOCK-----` and `-----END PGP PUBLIC KEY BLOCK-----`

## 4. Create multiple Root accounts, IAM Groups, IAM accounts and EC2 instances
### Overview: 
Given an existing OU id `ou_id`,
a root emial address `aws-account+jgi-sandbox@lbl.gov`
and the total number of accounts,
the Python script `generate_tf.py` generates a Terraform script `main.tf` with a list of root account email addresses `aws-account+jgi-sandbox-${ou_id}-root-${index}@lbl.gov`; __for each email address__, Terraform creates: 
* An Root USER Account
* An IAM Group with Roles and Policies
* An IAM User under the Root Account 
* An EC2 instance under the Root Account
```
$ cd ./multi_account_multi_user
$ tree
```
```
├── data			# Inline policies for group module
│   ├── iamfullaccess.json      
│   └── mfa_policy.json		
├── generate_output.py		# generate outputs after terraform applied
├── generate_tf.py 		# generate 'main.tf' given a email list
├── main.tf 			# run terraform here
├── Makefile
├── modules
│   ├── account			# Root account module
│   │   ├── main.tf 		# called by terraform apply
│   │   └── variables.tf
│   ├── ec2_instance		# EC2 instance module  
│   │   ├── main.tf 		# called by account module 
│   │   └── variables.tf
│   ├── group			# IAM Groups, Roles and Policies
│   │   ├── main.tf 		# called by account module 
│   │   └── variables.tf
│   ├── ou			# Organization module 
│   │   ├── main.tf		# (placeholder, not used by JGI workshop)
│   │   └── variables.tf
│   └── user			# IAM user module 
│       ├── main.tf 		# called by account module 
│       └── variables.tf
├── outputs			# Output tables
│   ├── resource_decrypted.csv  # table with IAM decrypted credentials 
│   └── resource_encrypted.csv  # table with IAM encrypted credentials 
└── variables.tf		# input variables 
```

### Inputs:
Modify `./variables.tf` and provide default values for:
* __`parent_ou_id`__ : (__required__) the existing Organization Unit under which the new root accounts will be created
* __`account_root_email`__ : (__required__) one email address for all root accounts. 
* __`total_accounts`__ : (__required__) total number of new root accounts. 
* __`pgp_key_default`__ : (__required__) PGP public key to encrypt IAM user's password and access-secret-key
* __`ami_id`__ : (__required__) AMI to create EC2 instances
* `region_default` : default region
* `instance_name` : default EC2 instance name prefix
* `instance_type` : default EC2 instance type


Currently, IAM users are given __Full Access__ for testing purpose. To limit IAM user's access, modify [group module: `./modules/group/main.tf`](./multi_account_multi_user/modules/group/main.tf)

```
## AWS Region
variable "region_default" {
  type    = string
  default = "us-west-2"
}

## AWS EC2
variable "instance_name" {
  type    = string
  default = "ExampleServerInstance"
}
variable "instance_type" {
  type    = string
  default = "t2.micro"
}
variable "ami_id" {
  type    = string
  default = "ami-123456"
}

## AWS Account
variable "parent_ou_id" {
  type    = string
  default = "ou-123456"
}

variable "account_root_email" {
  type    = string
  default = "email address"
}

variable "total_accounts" {
  type    = number
  default = 2
}

variable "pgp_key_default" {
  type    = string
  default = <<EOF
mQINBGLgn5cBEAD...
EOF

```

### Generate `main.tf`
Depending on the total number of root accounts, `account_root_email` in `variables.tf`, this Python script generates `main.tf` for Terraform 

```
$ pip3 install pyhcl
$ python3 generate_tf.py 
```

### Format check
```
$ terraform fmt --recursive
```

### Validation, Plan, and Review
```
$ terraform init
Terraform has been successfully initialized!
```
```
$ terraform validate
Success! The configuration is valid.
```
```
$ terraform plan
No changes. Your infrastructure matches the configuration.
```
Before `apply`, review the outputs from `terraform plan` and make sure all configurations are correct.

### Create Root & IAM accounts, groups and EC2
```
$ terraform apply
```

### Outputs:
The IAM user credentials in Terraform outputs are encrypted with the PGP public key in `variables.tf`, the credentials need to be decrypted by the PGP private key.
```
$ terraform output RESOURCE
```
```
[
  [
    {
      "EC2_INSTANCES" = {
        "ec2_ami" = "ami-123456"
        "ec2_arn" = "arn:aws:ec2:us-west-2:123456:instance/i-123456"
        "ec2_id" = "i-123456"
        "ec2_name" = "ExampleServerInstance_root_2"
        "ec2_public_ip" = "127.0.0.1"
        "ec2_type" = "t2.micro"
      }
    },
    {
      "IAM_USERS" = {
        "access_key_id" = "encrypted"
        "name" = "root_2_iam_1"
        "password" = "encrypted"
        "secret_access_key" = "encrypted"
      }
    },
    {
      "IAM_GROUPS" = {
        "id" = "root_2_group_1"
        "name" = "root_2_group_1"
      }
    },
    {
      "ROOT_ACCOUNTS" = {
        "arn" = "arn:aws:organizations::123456:account/o-123456/123456"
        "close_on_deletion" = true
        "email" = "root03_EMAIL"
        "iam_user_access_to_billing" = "DENY"
        "id" = "123456"
        "joined_method" = "CREATED"
        "joined_timestamp" = "2022-07-30T20:31:43Z"
        "name" = "root_2"
        "parent_id" = "ou-123456"
        "role_name" = "admin"
        "status" = "ACTIVE"
        "tags" = tomap({})
        "tags_all" = tomap({})
      }
    },
  ],
]
```

### Decrypt the login and access-key credentials for IAM users 
```
$ python3 generate_output.py 
```

### View IAM User login URL and credentials
```
$ cat outputs/resource_decrypted.csv | column -t -s, 
```
|iam_url|iam_name|iam_passwd|iam_key_id|iam_key|root_id|root_name|root_email|root_ou|ec2_id|ec2_IP|
|---|---|---|---|---|---|---|---|---|---|---|
|123456.signin.aws.amazon.com/console|root_2_iam_1|decrypted**|decrypted**|decrypted**|123456|root_2|root03_EMAIL|ou-123456|i-123456|127.0.0.1|

Log into AWS console as IAM user using credentials and login URL _https://`root-account-id`.signin.aws.amazon.com/console_

## 5. Reuse Modules 

Modules under [`multi_account_multi_user/modules`](./multi_account_multi_user/modules/) can be reused to create IAM users or EC2 instances directly under the root account that your current IAM account belongs to.

(This is different from Step 4 creating multiple root accounts under an OU, and IAM users under each root account)

```
multi_account_multi_user/modules/
├── account
│   ├── main.tf
│   └── variables.tf
├── ec2_instance
│   ├── main.tf
│   └── variables.tf
├── group
│   ├── main.tf
│   └── variables.tf
├── ou
│   ├── main.tf
│   └── variables.tf
└── user
    ├── main.tf
    └── variables.tf

```

### 5.1. Create new IAM user and Group under the current root account
Run terrafrom under [`./examples/iam_user/`](./examples/iam_user/)
```
$ cd ./examples/user/
```
Replace:
* the default pgp public key in `variables.tf` with the key created using GPG in Step 3.
* the default AWS region
* the default new Group Name
* the default new IAM username 

#### Validation, Plan, and Review
```
$ terraform init
$ terraform validate
$ terraform plan
```

#### Create a new Group and a new IAM user
```
$ terraform apply
```

#### View the new IAM user's credentials, and new Group name
```
$ terraform output
```

### 5.2. Create a new EC2 under the current root account
Run terrafrom under [`./examples/ec2/`](./examples/ec2/)
```
$ cd ./examples/ec2/
```
Modify the default aws region, and instance name, type & AMI in `variables.tf`.

#### Validation, Plan, and Review
```
$ terraform init
$ terraform validate
```
```
$ terraform plan
```

#### Create a new EC2
```
$ terraform apply
```

#### View the public IP of EC2
```
$ terraform output
```
